<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>FinAssist Widget</title>
    <link rel="stylesheet" href="style.css">
    <link rel="icon" href="favicon.ico">
    <script src="https://cdn.jsdelivr.net/npm/emoji-mart@latest/dist/browser.js"></script>
</head>

<body>


<div class="page"> 
<!-- Floating Chat Widget -->
<div class="chat-widget" id="chatWidget">

    <!-- HEADER -->
    <div class="chat-header">
        <div class="bot-info">
            <div class="bot-icon">üí∞</div>
            <div>
                <div class="bot-name">Byrz Assistant</div>
                <div class="bot-status">‚óè We're online</div>
            </div>
        </div>

        <div class="header-actions">
            <button type="button" onclick="refreshChat(event)">‚ü≥</button>
        </div>
    </div>

    <!-- BODY -->
    <div class="chat-body" id="messages">

        <div class="date">Today</div>

        <div class="bot-bubble">
            Hi there! Nice to see you üôÇ
            We have a finance assistant ready to help you.
        </div>

        <div class="quick-replies">
            <button onclick="quickReply('Yes, sure!')">Yes, sure!</button>
            <button onclick="quickReply('No, thanks!')">No, thanks!</button>
        </div>

        <div class="suggested" onclick="quickReply(this.innerText)">
            What are your most popular financial tips?
        </div>

    </div>

    <!-- INPUT -->
    <div class="chat-input">
        <button type="button" onclick="toggleEmoji()">üòä</button>
        <button type="button" onclick="uploadFile()">üìé</button>
        
        <input id="input" placeholder="Enter message">
        <button onclick="send()">‚û§</button>


        <div id="emojiPicker"
        style="position:absolute; bottom:60px;right:2px; display:none; z-index:999;">

        
        </div>
    </div>
</div>
</div>
<input type="file" id="fileInput" style="display:none" onchange="handleFile(event)">
<script>

const backend="https://chat-bot-86is.onrender.com/chat";
const session_id="user_"+Math.floor(Math.random()*10000);

/* Send */
async function send(){
    const input=document.getElementById("input");
    const msg=input.value;
    if(!msg) return;

    addMessage("user",msg);
    input.value="";
    autoScroll();


    const typing = addTyping();

    const res=await fetch(backend,{
        method:"POST",
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({session_id:session_id,message:msg})
    });

    const data=await res.json();
    typing.remove();
    addMessage("bot",data.response);
    autoScroll();
}

async function quickReply(text){

    // ‚≠ê add user message
    addMessage("user", text);
    autoScroll();

    // ‚≠ê remove quick replies block
    document.querySelectorAll(".quick-replies button")
    .forEach(b=>b.disabled=true);

    // ‚≠ê show typing
    const typing = addTyping();

    // ‚≠ê send to backend
    const res = await fetch(backend,{
        method:"POST",
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({session_id:session_id,message:text})
    });

    const data = await res.json();

    typing.remove();
    addMessage("bot", data.response);
    autoScroll();
}



/* Add message */
function addMessage(role,text){
    const div=document.createElement("div");
    div.className=role==="user" ? "user-bubble" : "bot-bubble";
    div.innerText=text;
    document.getElementById("messages").appendChild(div);
    return div;
}

function addTyping(){
    const div=document.createElement("div");
    div.className="bot-bubble typing";
    div.innerText="...";
    document.getElementById("messages").appendChild(div);
    return div;
}


/* Auto scroll */
function autoScroll(){
    const box=document.getElementById("messages");
    box.scrollTop = box.scrollHeight;
}

/* Enter key */
document.getElementById("input").addEventListener("keypress", function(e){
    if(e.key==="Enter"){
        e.preventDefault();
        send();
    }
});

/* Refresh */
function refreshChat(){
    const box=document.getElementById("messages");

    box.innerHTML = `
        <div class="date">Today</div>
        <div class="bot-bubble">
            Hi there! Nice to see you üôÇ
            We have a finance assistant ready to help you.
        </div>
    `;
}

/* ‚≠ê Emoji picker logic */
let pickerCreated = false;

function toggleEmoji(){
    const pickerDiv = document.getElementById("emojiPicker");

    // create only once
    if(!pickerCreated){
        const picker = new EmojiMart.Picker({
            theme: "light",
            onEmojiSelect: (emoji)=>{
                document.getElementById("input").value += emoji.native;
            }
        });

        pickerDiv.appendChild(picker);
        pickerCreated = true;
    }

    // toggle visibility
    pickerDiv.style.display =
        pickerDiv.style.display === "none" ? "block" : "none";
}
document.addEventListener("click", (e)=>{
    const picker = document.getElementById("emojiPicker");

    if(!e.target.closest("#emojiPicker") && !e.target.closest("[onclick='toggleEmoji()']")){
        picker.style.display="none";
    }
});


/* ‚≠ê Open file dialog */
function uploadFile(){
    document.getElementById("fileInput").click();
}

/* ‚≠ê Handle selected file */
function handleFile(e){
    const file = e.target.files[0];
    if(!file) return;

    const messages = document.getElementById("messages");

    // ‚≠ê IMAGE FILE
    if(file.type.startsWith("image/")){
        const wrapper = document.createElement("div");
        wrapper.className = "user-bubble";

        const img = document.createElement("img");
        img.src = URL.createObjectURL(file);
        img.style.maxWidth = "160px";
        img.style.borderRadius = "10px";
        img.style.display = "block";

        wrapper.appendChild(img);
        messages.appendChild(wrapper);
    }

    // ‚≠ê VIDEO FILE
    else if(file.type.startsWith("video/")){
        const wrapper = document.createElement("div");
        wrapper.className="user-bubble";

        const video=document.createElement("video");
        video.src=URL.createObjectURL(file);
        video.controls=true;
        video.style.maxWidth="160px";

        wrapper.appendChild(video);
        messages.appendChild(wrapper);
    }

    // ‚≠ê OTHER FILES
    else{
        const wrapper=document.createElement("div");
        wrapper.className="user-bubble";
        wrapper.innerText="üìé "+file.name;
        messages.appendChild(wrapper);
    }

    autoScroll();

    // ‚≠ê IMPORTANT ‚Üí allow same file again
    e.target.value="";

    // ‚≠ê OPTIONAL ‚Üí send to backend
    uploadToBackend(file);
    function uploadToBackend(file){
        console.log("Upload placeholder:", file.name);
    }
}


</script>

</body>
</html>
